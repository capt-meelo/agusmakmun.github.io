---
layout: post
title:  "[Backdoor 101] Backdooring PE File by Adding New Section Header"
date:   2018-07-16
categories: [exploitdev, osceprep]
---

## Introduction

In this post, I’m going to discuss how to inject a shellcode in an executable file. I’m also going to discuss the problem that I encountered along the way, and the solutions that I came up with. 


The executable file that I’m going to backdoor is Putty v0.66 which can be downloaded [here](https://www.chiark.greenend.org.uk/~sgtatham/putty/releases/0.66.html).


Before anything else, let’s first discuss what a code cave is. According to [Wikipedia](https://en.wikipedia.org/wiki/Code_cave):
> _A **code cave** is a series of null bytes in a process's memory. The code cave inside a process's memory is often a reference to a section of the code’s script functions that have capacity for the injection of custom instructions. For example, if a script’s memory allows for 5 bytes and only 3 bytes are used, then the remaining 2 bytes can be used to add external code to the script._


If you want to learn more about code cave, this [article](https://www.codeproject.com/Articles/20240/The-Beginners-Guide-to-Codecaves) provides a good insight about it. I highly recommend that you read it. :thumbsup:  


## Program’s Execution Flow
The following diagram shows the execution flow of the executable file, before and after the modification. As you can see, we will create a code cave by inserting a new section header to the executable file, and redirect the program’s execution flow to it. Once the shellcode in our code cave is executed, we will jump back to the original code that was meant to be executed by the program, and continue the execution as if nothing changes.
![Program Flow](/static/img/08/01.png)


## Adding a New Section Header (Code Cave)

Before adding a new section header to the exe file, let’s first upload it to [Virustotal](https://www.virustotal.com/). The file was detected as clean, with a detection rate of **0/68**.
![Detection1](/static/img/08/02.png)

Now, let’s add a new section to the exe file. To do this, we’re going to use **LordPE** which can be downloaded [here](http://www.woodmann.com/collaborative/tools/index.php/LordPE). Once downloaded, open **LordPE**, click the _**PE Editor**_ button, and then select our exe file (putty.exe). To view the current section headers of the file, click the _**Sections**_ button. To add a new section header, _**righ-click**_ anywhere in the available sections then select _**add section header…**_.
![Lord PE](/static/img/08/03.png)

A new section header called **.NewSec** is created. Let’s set its size by editing this new section header. 
![New Section1](/static/img/08/04.png)

We’re going to rename the new section to **.meelo**, and set the value of **VirtualSize** and **RawSize** to **00001000** _(**Note:** This value is in hex format. So the actual size of this section is 4096 bytes.)_. Before saving the changes that we’ve made, let’s first check the flags by clicking the _**…**_ button. Make sure that this section is **writeable** and **executable**.
![New Section2](/static/img/08/05.png)

Once done, let’s save the changes that we've made to the file. If we open up the modified exe file, an error like this shows up. Why? That’s because we created a section header to the exe file which is empty.
![Error](/static/img/08/06.png)

To fix the error, let’s open the modified exe file using a Hex Editor called **XVI32**, which is available [here](http://www.chmaas.handshake.de/delphi/freeware/xvi32/xvi32.htm), and then add **1000h bytes** of data to the binary by going to _**Edit** > **Insert String…**_.  
![XVI1](/static/img/08/07.png)

Then insert a **Hex string** value of **00** and make sure that it is inserted **1000 times**. Before pressing _**OK**_, note that the last address of the exe file is `0x7FFFF`.
![XVI2](/static/img/08/08.png)

Upon pressing _**OK**_, we can see that the last address becomes `0x80FFF`. Lastly, save the changes made to the file.
![XVI3](/static/img/08/09.png)

Now, when we open putty, the error is gone. That’s great! :smile:
![Putty Runs](/static/img/08/10.png)

If we check the modified file to VirusTotal again, we can see that it’s now being detected as malicious with a detection rate of **14/66**.
![Detection2](/static/img/08/11.png)


## Hijacking the Program’s Execution Flow

Before modifying the program’s flow, let’s first get the first 3 instructions that the program will execute upon opening. As seen below, the program’s entry point is at `0x00454eB0` with an instruction of `PUSH 60`. 
![Entry Point](/static/img/08/12.png)

Let's note the first 3 instructions of the program.
```
00454EB0 > $ 6A 60          PUSH 60
00454EB2   . 68 707B4700    PUSH putty.00477B70
00454EB7   . E8 08210000    CALL putty.00456FC4
```
